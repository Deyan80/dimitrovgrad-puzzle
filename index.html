<canvas id="board" width="600" height="400"></canvas>

<script>
let canvas = document.getElementById('board');
let ctx = canvas.getContext('2d');
let img = document.getElementById('source');
let size = 3;
let tileSize;
let board = [];
let blankPos = {x: 0, y: 0};
let draggedTile = null;
let isLoaded = false;

img.onload = () => {
    isLoaded = true;
    init(size);
};

function init(newSize) {
    size = newSize;
    tileSize = Math.min(canvas.width / size, canvas.height / size);
    canvas.width = tileSize * size;
    canvas.height = tileSize * size;

    board = Array.from({length: size * size}, (_, i) => i);
    board[size * size - 1] = -1;
    blankPos = {x: size - 1, y: size - 1};

    draw();

    // махаме предишни слушатели
    canvas.replaceWith(canvas.cloneNode(true));
    canvas = document.getElementById('board');
    ctx = canvas.getContext('2d');

    canvas.addEventListener('pointerdown', startPointer);
    canvas.addEventListener('pointermove', movePointer);
    canvas.addEventListener('pointerup', endPointer);
    canvas.addEventListener('pointerleave', cancelPointer);
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let i = 0; i < board.length; i++) {
        let row = Math.floor(i / size);
        let col = i % size;
        let x = col * tileSize;
        let y = row * tileSize;
        let tileNum = board[i];
        if (tileNum !== -1) {
            let srcRow = Math.floor(tileNum / size);
            let srcCol = tileNum % size;
            ctx.drawImage(img, srcCol * tileSize, srcRow * tileSize, tileSize, tileSize, x, y, tileSize, tileSize);
        } else {
            ctx.fillStyle = 'white';
            ctx.fillRect(x, y, tileSize, tileSize);
            ctx.strokeStyle = '#333';
            ctx.strokeRect(x, y, tileSize, tileSize);
        }
    }
}

function getTileAt(x, y) {
    let col = Math.floor(x / tileSize);
    let row = Math.floor(y / tileSize);
    if (col >= 0 && col < size && row >= 0 && row < size) {
        return row * size + col;
    }
    return -1;
}

function startPointer(e) {
    if (!isLoaded) return;
    let rect = canvas.getBoundingClientRect();
    let x = e.clientX - rect.left;
    let y = e.clientY - rect.top;
    let index = getTileAt(x, y);
    if (index >= 0 && board[index] !== -1) {
        draggedTile = index;
    }
}

function movePointer(e) {
    if (draggedTile === null) return;
    // тук може да добавиш визуален ефект (напр. подсветка) при влачене
}

function endPointer(e) {
    if (draggedTile === null) return;
    let rect = canvas.getBoundingClientRect();
    let x = e.clientX - rect.left;
    let y = e.clientY - rect.top;
    let targetIndex = getTileAt(x, y);
    let blankIndex = blankPos.y * size + blankPos.x;

    if (targetIndex === blankIndex) {
        [board[draggedTile], board[blankIndex]] = [board[blankIndex], board[draggedTile]];
        blankPos.x = draggedTile % size;
        blankPos.y = Math.floor(draggedTile / size);
        draw();
    }
    draggedTile = null;
}

function cancelPointer() {
    draggedTile = null;
}
</script>

